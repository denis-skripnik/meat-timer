<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="pageTitle">–¢–∞–π–º–µ—Ä –¥–ª—è –≥–æ—Ç–æ–≤–∫–∏ –º—è—Å–∞</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: sans-serif;
      background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
      color: #f5f5f5;
      text-align: center;
      padding: 50px;
      overflow: hidden;
    }
    h1 { font-size: 2em; margin-bottom: 20px; }
    input[type="number"], input[type="range"] { margin: 10px; font-size: 1.2em; }
    button {
      background: #333; color: #fff; border: none; border-radius: 8px;
      padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 1em;
      transition: background 0.2s;
    }
    button:hover { background: #555; }
    #timer { font-size: 3em; margin-top: 30px; }
    .flame {
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 120px; height: 160px;
      background: radial-gradient(ellipse at center, #ff6600 0%, transparent 70%);
      opacity: 0.7; animation: flame 1s infinite alternate; filter: blur(15px);
      display: none;
    }
    @keyframes flame {
      0% { transform: translateX(-50%) scale(1,1); opacity:0.7; }
      100% { transform: translateX(-50%) scale(1.3,1.4); opacity:0.3; }
    }
    #languageSwitcher {
      position: absolute; top: 10px; right: 10px;
    }
    #languageSwitcher button {
      padding: 5px 10px; font-size: 0.9em; opacity: 0.5;
    }
    #languageSwitcher button.active {
      opacity: 1; background: #555;
    }
  </style>
</head>
<body>
  <div id="languageSwitcher">
    <button onclick="switchLanguage('en')" id="langEn">üá¨üáß EN</button>
    <button onclick="switchLanguage('ru')" id="langRu">üá∑üá∫ RU</button>
  </div>

  <h1 data-i18n="mainHeading">üî• –¢–∞–π–º–µ—Ä –¥–ª—è –≥–æ—Ç–æ–≤–∫–∏ –º—è—Å–∞ üî•</h1>

  <div>
    <input id="minutesInput" type="number" min="1" max="120" value="10"> <span data-i18n="minutesLabel">–º–∏–Ω</span>
    <br>
    <input id="rangeInput" type="range" min="1" max="120" value="10">
  </div>

  <div>
    <button onclick="setPreset(5)">5</button>
    <button onclick="setPreset(10)">10</button>
    <button onclick="setPreset(20)">20</button>
    <button onclick="setPreset(30)">30</button>
    <button onclick="setPreset(40)">40</button>
    <button onclick="setPreset(50)">50</button>
    <button onclick="setPreset(60)">60</button>
  </div>

  <div>
    <button onclick="startTimer()" data-i18n="startButton">–°—Ç–∞—Ä—Ç</button>
    <button onclick="resetTimer()" data-i18n="resetButton">–°–±—Ä–æ—Å</button>
  </div>

  <div style="margin-top: 15px;">
    <label style="cursor: pointer; font-size: 0.9em;">
      <input type="checkbox" id="wakeLockCheckbox" style="margin-right: 5px;">
      <span data-i18n="wakeLockLabel">–ù–µ –≤—ã–∫–ª—é—á–∞—Ç—å —ç–∫—Ä–∞–Ω</span>
    </label>
  </div>

  <div id="timer">00:00</div>
  <div class="flame" id="flame"></div>

  <script>
    // Translations dictionary
    const translations = {
      en: {
        pageTitle: "Meat Cooking Timer",
        mainHeading: "üî• Meat Cooking Timer üî•",
        minutesLabel: "min",
        startButton: "Start",
        resetButton: "Reset",
        wakeLockLabel: "Keep screen on",
        invalidTimeAlert: "Enter valid time!",
        timerStarted: "Timer started for {minutes} minutes.",
        minutePassed: "Minute {minute} passed. Time to flip the meat.",
        cookingComplete: "Cooking complete! You can remove the meat from heat.",
        minuteTitle: "Cooking Minute",
        finishTitle: "Cooking Complete"
      },
      ru: {
        pageTitle: "–¢–∞–π–º–µ—Ä –¥–ª—è –≥–æ—Ç–æ–≤–∫–∏ –º—è—Å–∞",
        mainHeading: "üî• –¢–∞–π–º–µ—Ä –¥–ª—è –≥–æ—Ç–æ–≤–∫–∏ –º—è—Å–∞ üî•",
        minutesLabel: "–º–∏–Ω",
        startButton: "–°—Ç–∞—Ä—Ç",
        resetButton: "–°–±—Ä–æ—Å",
        wakeLockLabel: "–ù–µ –≤—ã–∫–ª—é—á–∞—Ç—å —ç–∫—Ä–∞–Ω",
        invalidTimeAlert: "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è!",
        timerStarted: "–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ {minutes} –º–∏–Ω—É—Ç.",
        minutePassed: "–ü—Ä–æ—à–ª–∞ {minute} –º–∏–Ω—É—Ç–∞. –ü–æ—Ä–∞ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –º—è—Å–æ.",
        cookingComplete: "–ì–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–æ–∂–Ω–æ —Å–Ω–∏–º–∞—Ç—å –º—è—Å–æ —Å –æ–≥–Ω—è.",
        minuteTitle: "–ú–∏–Ω—É—Ç–∫–∞ –≥–æ—Ç–æ–≤–∫–∏",
        finishTitle: "–ì–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
      }
    };

    let currentLanguage = 'ru';
    let totalMinutes = 10;
    let remainingSeconds = 0;
    let timerInterval = null;
    let minuteCounter = 0;
    let wakeLock = null;
    const wakeLockCheckbox = document.getElementById('wakeLockCheckbox');

    async function requestWakeLock() {
      if (wakeLock) return;
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock released');
            wakeLock = null;
          });
        } catch (err) {
          console.error('Wake Lock error:', err);
        }
      }
    }

    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
    }

    wakeLockCheckbox.addEventListener('change', () => {
      if (timerInterval) {  // Timer is running
        if (wakeLockCheckbox.checked) {
          requestWakeLock();
        } else {
          releaseWakeLock();
        }
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && timerInterval && wakeLockCheckbox.checked) {
        requestWakeLock();
      }
    });

    const minutesInput = document.getElementById('minutesInput');
    const rangeInput = document.getElementById('rangeInput');
    const timerDisplay = document.getElementById('timer');
    const flame = document.getElementById('flame');

    minutesInput.addEventListener('input', () => { rangeInput.value = minutesInput.value; });
    rangeInput.addEventListener('input', () => { minutesInput.value = rangeInput.value; });

    function setPreset(mins) {
      minutesInput.value = mins;
      rangeInput.value = mins;
    }

    function switchLanguage(lang) {
      currentLanguage = lang;
      
      // Save to localStorage
      localStorage.setItem('preferredLanguage', lang);
      
      // Update all elements with data-i18n
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (element.tagName === 'TITLE') {
          element.textContent = translations[lang][key];
        } else {
          element.textContent = translations[lang][key];
        }
      });
      
      // Update document title
      document.title = translations[lang].pageTitle;
      
      // Update lang attribute
      document.documentElement.lang = lang;
      
      // Update language buttons
      updateLanguageButtons(lang);
    }

    function updateLanguageButtons(lang) {
      document.getElementById('langEn').classList.toggle('active', lang === 'en');
      document.getElementById('langRu').classList.toggle('active', lang === 'ru');
    }

    function initLanguage() {
      // Check saved preference
      const saved = localStorage.getItem('preferredLanguage');
      
      // Or detect browser language
      const browserLang = navigator.language.startsWith('ru') ? 'ru' : 'en';
      
      const lang = saved || browserLang;
      switchLanguage(lang);
    }

    function speak(textKey, params = {}) {
      let text = translations[currentLanguage][textKey];
      
      // Replace placeholders
      Object.keys(params).forEach(key => {
        text = text.replace(`{${key}}`, params[key]);
      });
      
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = currentLanguage === 'ru' ? 'ru-RU' : 'en-US';
      utter.volume = 1.0;
      utter.rate = 1.05;
      utter.pitch = 1.2;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    function playBeep(frequency = 880, duration = 200, volume = 1.0) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = frequency;
      osc.type = "triangle";
      gain.gain.setValueAtTime(volume, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + duration / 1000);
    }

    // --- Service Worker communication helper ---
    async function sendToSW(payload) {
      if (!('serviceWorker' in navigator)) return false;
      try {
        const registration = await navigator.serviceWorker.ready;
        const target = navigator.serviceWorker.controller || registration.active;
        if (target) {
          target.postMessage(payload);
          return true;
        }
      } catch (e) {
        console.error('SW send error:', e);
      }
      return false;
    }

    function notifyMinute(minuteCounter) {
      const text = translations[currentLanguage].minutePassed.replace('{minute}', minuteCounter);
      const title = translations[currentLanguage].minuteTitle;
      sendToSW({ type: 'MINUTE_NOTIFICATION', title, text });
    }

    function notifyFinish() {
      const text = translations[currentLanguage].cookingComplete;
      const title = translations[currentLanguage].finishTitle;
      sendToSW({ type: 'FINISH_NOTIFICATION', title, text });
    }

    function startTimer() {
      if (timerInterval) return;
      totalMinutes = parseInt(minutesInput.value);
      if (isNaN(totalMinutes) || totalMinutes <= 0) return alert(translations[currentLanguage].invalidTimeAlert);
      
      // Request notification permission if not already decided
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
      
      remainingSeconds = totalMinutes * 60;
      minuteCounter = 0;
      updateDisplay();
      flame.style.display = 'block';
      if (wakeLockCheckbox.checked) {
        requestWakeLock();
      }
      speak('timerStarted', { minutes: totalMinutes });
      playBeep();
      timerInterval = setInterval(tick, 1000);
    }

    function tick() {
      remainingSeconds--;
      updateDisplay();

      if (remainingSeconds % 60 === 0 && remainingSeconds > 0) {
        minuteCounter++;
        playBeep(600, 150);
        playBeep(900, 150);
        setTimeout(() => speak('minutePassed', { minute: minuteCounter }), 1000);
        notifyMinute(minuteCounter);
      }

      if (remainingSeconds <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        releaseWakeLock();
        flame.style.display = 'none';
        playBeep(700, 200);
        playBeep(1000, 300);
        playBeep(1200, 400);
        setTimeout(() => speak('cookingComplete'), 1000);
        notifyFinish();
      }
    }

    function resetTimer() {
      releaseWakeLock();
      clearInterval(timerInterval);
      timerInterval = null;
      remainingSeconds = 0;
      timerDisplay.textContent = '00:00';
      flame.style.display = 'none';
      speechSynthesis.cancel();
    }

    function updateDisplay() {
      const m = Math.floor(remainingSeconds / 60);
      const s = remainingSeconds % 60;
      timerDisplay.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    // --- Initialize language on page load ---
    window.addEventListener('DOMContentLoaded', initLanguage);

    // --- Register service worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' }).then(() => console.log('SW registered'));
    }
  </script>
</body>
</html>
